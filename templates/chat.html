<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Arogya Gemini</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">Arogya Gemini</div>
        <div class="nav-links">
            <a href="{{ url_for('chat') }}">Chat</a>
            <a href="{{ url_for('hospitals') }}">Hospitals</a>
            <a href="{{ url_for('history') }}">History</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </nav>
    
    <div class="score-box">
        <div class="gauge">
            <div class="gauge-body">
                <div class="gauge-fill" id="gaugeFill"></div>
                <div class="gauge-cover" id="gaugeValue">{{ health_score }}</div>
            </div>
        </div>
        <p class="score-label">Health Score</p>
    </div>
    
    <div class="chat-container">
        <div class="chat-header">
            <h2>Chat with Arogya Gemini</h2>
            <p>Describe your symptoms or health concerns</p>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
                <div class="message-bubble glass-bubble">
                    <p>Hello! I'm Arogya Gemini, your health assistant. How can I help you today?</p>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="input-actions">
                <button id="voiceBtn" class="icon-button" title="Voice Input">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="chatInput" placeholder="Type your symptoms here..." />
            <button id="sendBtn" class="neon-button">Send</button>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        let currentHealthScore = {{ health_score }};
        let recognition = null;
        
        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('chatInput').value = transcript;
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
            };
        }
        
        document.getElementById('voiceBtn').addEventListener('click', () => {
            if (recognition) {
                recognition.start();
                document.getElementById('voiceBtn').classList.add('recording');
            } else {
                alert('Speech recognition not supported in your browser');
            }
        });
        
        if (recognition) {
            recognition.onend = () => {
                document.getElementById('voiceBtn').classList.remove('recording');
            };
        }
        
        function addMessage(text, isBot = false, severity = 'normal') {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isBot ? 'message bot-message' : 'message user-message';
            
            const bubble = document.createElement('div');
            bubble.className = `message-bubble glass-bubble severity-${severity}`;
            bubble.innerHTML = `<p>${text}</p>`;
            
            messageDiv.appendChild(bubble);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Text to speech for bot messages
            if (isBot && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }
        
        function updateHealthScore(score) {
            currentHealthScore = score;
            document.getElementById('gaugeValue').textContent = score;
            const rotation = (score / 100) * 180 - 90;
            document.getElementById('gaugeFill').style.transform = `rotate(${rotation}deg)`;
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const symptom = input.value.trim();
            
            if (!symptom) return;
            
            addMessage(symptom, false);
            input.value = '';
            
            // Show typing animation
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message';
            typingDiv.innerHTML = '<div class="message-bubble glass-bubble"><div class="typing-animation"><span></span><span></span><span></span></div></div>';
            document.getElementById('chatMessages').appendChild(typingDiv);
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({symptom})
                });
                
                const data = await response.json();
                
                // Remove typing animation
                if (typingDiv && typingDiv.parentNode) {
                    typingDiv.parentNode.removeChild(typingDiv);
                }
                
                if (!response.ok) {
                    throw new Error(data.error || 'Server error');
                }
                
                if (data.reply) {
                    addMessage(data.reply, true, data.severity);
                    if (data.health_score !== undefined) {
                        updateHealthScore(data.health_score);
                    }
                } else {
                    throw new Error(data.error || 'No reply received');
                }
            } catch (error) {
                // Remove typing animation on error
                if (typingDiv && typingDiv.parentNode) {
                    typingDiv.parentNode.removeChild(typingDiv);
                }
                const errorMsg = error.message || 'Network error. Please try again.';
                addMessage(`Error: ${errorMsg}`, true, 'normal');
                console.error('Chat error:', error);
            }
        }
        
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // Initialize health score gauge
        updateHealthScore(currentHealthScore);
    </script>
</body>
</html>

